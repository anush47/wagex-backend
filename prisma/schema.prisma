// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"

}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  EMPLOYER
  EMPLOYEE
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

model Company {
  id        String   @id @default(uuid())
  name      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employerNumber String?
  address        String?
  startedDate    DateTime?
  logo           String?
  files          Json?     @default("[]") // [{ key: string, name: string, url: string }]

  // Relationships
  memberships UserCompany[]
  employees   Employee[]
  policy      Policy?       // Optional: Company-wide default policy

  @@map("companies")
}

model User {
  id        String   @id @default(uuid()) // Maps to Supabase Auth UID
  email     String   @unique
  
  nameWithInitials String?
  fullName         String?
  address          String?
  phone            String?

  role      Role     @default(EMPLOYEE) // Global role
  active    Boolean  @default(false)

  
  // Relationships
  memberships   UserCompany[]
  notifications Notification[]
  employees     Employee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model UserCompany {
  id        String   @id @default(uuid())
  userId    String
  companyId String
  
  // Specific role within this company
  role      Role     @default(EMPLOYEE)
  
  // Granular permissions for this company
  // Example: { "can_edit_payroll": true, "can_view_audit": false }
  // Granular permissions for this company
  // Example: { "can_edit_payroll": true, "can_view_audit": false }
  permissions Json?    @default("{}")
  
  active    Boolean    @default(false) // Whether user has active portal access to this company

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id])
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("user_companies")
}

enum EmploymentType {
  PROBATION
  CONTRACT
  INTERN
  PERMANENT
  TEMPORARY
}

enum Gender {
  MALE
  FEMALE
}

model Employee {
  id         String   @id @default(uuid())
  employeeNo Int
  nic        String?
  nameWithInitials String
  fullName   String
  designation String?
  address    String?
  phone      String?
  email      String?  @unique // For user linking
  basicSalary Float   @default(0.0)
  status     String   @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED
  gender     Gender   @default(MALE)
  employmentType EmploymentType @default(PERMANENT)


  joinedDate   DateTime @default(now())
  resignedDate DateTime?
  remark       String?   @db.Text

  // Foreign Keys
  companyId  String
  company    Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  userId     String? // Link to Auth User (Nullable for now to support legacy)
  user       User?   @relation(fields: [userId], references: [id])

  // Manager Self-Relation
  managerId  String?
  manager    Employee?  @relation("EmployeeManager", fields: [managerId], references: [id])
  reports    Employee[] @relation("EmployeeManager")
  
  canSelfEdit Boolean   @default(true)
  photo       String?
  files       Json?     @default("[]") // [{ key: string, name: string, url: string }]

  // Future relations for Payroll, Attendance, etc.
  // payrolls Payroll[]
  // attendance Attendance[]

  policy    Policy?     // Optional: Employee-specific override policy

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([companyId, employeeNo]) // Employee No unique per company
  @@map("employees")
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String   // CREATE, UPDATE, DELETE, PATCH
  resource   String   // User, Company, Employee
  resourceId String?  // ID of affected resource
  
  userId     String?  // Who performed the action
  ipAddress  String?
  userAgent  String?

  details    Json?    // Store old/new values

  createdAt  DateTime @default(now())

  @@map("audit_logs")
}

model Policy {
  id        String   @id @default(uuid())
  
  // The JSON structure for configuration
  // stores { shifts: [], attendance: {}, payroll: {} }
  settings  Json     @default("{}")

  // Relationships (Polymorphic-like via optional FKs)
  companyId String?  @unique
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  employeeId String? @unique
  employee   Employee? @relation(fields: [employeeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("policies")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id])
  title     String
  message   String
  type      NotificationType @default(INFO)
  isRead    Boolean          @default(false)
  metadata  Json?            @default("{}")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@map("notifications")
}
