generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Company {
  id                 String              @id @default(uuid())
  name               String
  active             Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  timezone           String              @default("UTC")
  employerNumber     String?
  address            String?
  startedDate        DateTime?
  logo               String?
  files              Json?               @default("[]")
  attendanceEvents   AttendanceEvent[]
  attendanceSessions AttendanceSession[]
  departments        Department[]
  employees          Employee[]
  leaveRequests      LeaveRequest[]
  payments           Payment[]
  policies           Policy[]
  salaries           Salary[]
  salaryAdvances     SalaryAdvance[]
  memberships        UserCompany[]

  @@map("companies")
}

model User {
  id               String         @id @default(uuid())
  email            String         @unique
  nameWithInitials String?
  fullName         String?
  address          String?
  phone            String?
  role             Role           @default(EMPLOYEE)
  active           Boolean        @default(false)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  employees        Employee[]
  notifications    Notification[]
  memberships      UserCompany[]

  @@map("users")
}

model UserCompany {
  id          String   @id @default(uuid())
  userId      String
  companyId   String
  role        Role     @default(EMPLOYEE)
  permissions Json?    @default("{}")
  active      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])

  @@unique([userId, companyId])
  @@map("user_companies")
}

model Department {
  id          String       @id @default(uuid())
  name        String
  companyId   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  headId      String?
  description String?
  parentId    String?
  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  head        Employee?    @relation("DepartmentHead", fields: [headId], references: [id])
  parent      Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children    Department[] @relation("DepartmentHierarchy")
  employees   Employee[]   @relation("DepartmentMembers")

  @@map("departments")
}

model Employee {
  id                 String              @id @default(uuid())
  employeeNo         Int
  nic                String?
  nameWithInitials   String
  fullName           String
  designation        String?
  address            String?
  phone              String?
  email              String?             @unique
  employmentType     EmploymentType      @default(PERMANENT)
  joinedDate         DateTime            @default(now())
  companyId          String
  userId             String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  departmentId       String?
  basicSalary        Float               @default(0.0)
  canSelfEdit        Boolean             @default(true)
  files              Json?               @default("[]")
  gender             Gender              @default(MALE)
  managerId          String?
  photo              String?
  remark             String?
  resignedDate       DateTime?
  status             String              @default("ACTIVE")
  policyId           String?
  attendanceEvents   AttendanceEvent[]
  attendanceSessions AttendanceSession[]
  headOfDepartments  Department[]        @relation("DepartmentHead")
  details            EmployeeDetail?
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department         Department?         @relation("DepartmentMembers", fields: [departmentId], references: [id])
  manager            Employee?           @relation("EmployeeManager", fields: [managerId], references: [id])
  reports            Employee[]          @relation("EmployeeManager")
  policy             Policy?             @relation(fields: [policyId], references: [id])
  user               User?               @relation(fields: [userId], references: [id])
  leaveRequests      LeaveRequest[]
  salaries           Salary[]
  salaryAdvances     SalaryAdvance[]

  @@unique([companyId, employeeNo])
  @@index([companyId])
  @@index([userId])
  @@map("employees")
}

model EmployeeDetail {
  id                    String        @id @default(uuid())
  employeeId            String        @unique
  bankName              String?
  bankBranch            String?
  accountNumber         String?
  mothersName           String?
  fathersName           String?
  maritalStatus         MaritalStatus @default(SINGLE)
  spouseName            String?
  nationality           String?       @default("Sri Lankan")
  emergencyContactName  String?
  emergencyContactPhone String?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  employee              Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("employee_details")
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String
  resourceId String?
  userId     String?
  ipAddress  String?
  userAgent  String?
  details    Json?
  createdAt  DateTime @default(now())
  companyId  String?
  entity     String?

  @@map("audit_logs")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Policy {
  id          String     @id @default(uuid())
  settings    Json       @default("{}")
  companyId   String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  description String?
  isDefault   Boolean    @default(false)
  name        String     @default("Default")
  employees   Employee[]
  company     Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("policies")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  title     String
  message   String
  type      NotificationType @default(INFO)
  isRead    Boolean          @default(false)
  metadata  Json?            @default("{}")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model LeaveRequest {
  id             String           @id @default(uuid())
  employeeId     String
  companyId      String
  leaveTypeId    String
  leaveTypeName  String?
  type           LeaveRequestType @default(FULL_DAY)
  startDate      DateTime
  endDate        DateTime
  days           Float
  minutes        Int?
  leaveNumber    Int?
  status         LeaveStatus      @default(PENDING)
  reason         String?
  managerId      String?
  responseReason String?
  documents      Json?            @default("[]")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  holidayId      String?
  company        Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee       Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  holiday        Holiday?         @relation(fields: [holidayId], references: [id])

  @@index([companyId])
  @@index([employeeId])
  @@index([status])
  @@index([leaveTypeId])
  @@index([holidayId])
  @@map("leave_requests")
}

model AttendanceEvent {
  id             String             @id @default(uuid())
  employeeId     String
  companyId      String
  eventTime      DateTime
  eventType      EventType
  source         EventSource
  apiKeyName     String?
  device         String?
  location       String?
  latitude       Float?
  longitude      Float?
  status         EventStatus        @default(ACTIVE)
  sessionId      String?
  manualOverride Boolean            @default(false)
  remark         String?
  metadata       Json?              @default("{}")
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  company        Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee       Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  session        AttendanceSession? @relation(fields: [sessionId], references: [id])

  @@index([employeeId, eventTime])
  @@index([companyId, eventTime])
  @@index([sessionId])
  @@index([status])
  @@map("attendance_events")
}

model AttendanceSession {
  id                    String               @id @default(uuid())
  employeeId            String
  companyId             String
  date                  DateTime             @db.Date
  shiftId               String?
  shiftName             String?
  shiftStartTime        String?
  shiftEndTime          String?
  shiftBreakMinutes     Int?
  checkInTime           DateTime?
  checkOutTime          DateTime?
  checkInLocation       String?
  checkInLatitude       Float?
  checkInLongitude      Float?
  checkOutLocation      String?
  checkOutLatitude      Float?
  checkOutLongitude     Float?
  totalMinutes          Int?
  breakMinutes          Int?
  workMinutes           Int?
  overtimeMinutes       Int?
  isLate                Boolean              @default(false)
  isEarlyLeave          Boolean              @default(false)
  isOnLeave             Boolean              @default(false)
  isHalfDay             Boolean              @default(false)
  hasShortLeave         Boolean              @default(false)
  manuallyEdited        Boolean              @default(false)
  autoCheckout          Boolean              @default(false)
  inApprovalStatus      ApprovalStatus       @default(PENDING)
  outApprovalStatus     ApprovalStatus       @default(PENDING)
  approvedById          String?
  approvedAt            DateTime?
  remarks               String?
  metadata              Json?                @default("{}")
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  workDayStatus         SessionWorkDayStatus @default(FULL)
  payrollHolidayId      String?
  workHolidayId         String?
  additionalInOutCount  Int?                 @default(0)
  isBreakOverrideActive Boolean              @default(false)
  events                AttendanceEvent[]
  company               Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee              Employee             @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  payrollHoliday        Holiday?             @relation("PayrollHoliday", fields: [payrollHolidayId], references: [id])
  workHoliday           Holiday?             @relation("WorkHoliday", fields: [workHolidayId], references: [id])

  @@unique([employeeId, date])
  @@index([companyId, date])
  @@index([inApprovalStatus])
  @@index([outApprovalStatus])
  @@map("attendance_sessions")
}

model Calendar {
  id          String    @id @default(uuid())
  name        String
  description String?
  isGlobal    Boolean   @default(false)
  companyId   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  holidays    Holiday[]

  @@index([companyId])
  @@map("calendars")
}

model Holiday {
  id              String              @id @default(uuid())
  calendarId      String
  date            DateTime            @db.Date
  name            String
  description     String?
  isPublic        Boolean             @default(false)
  isMercantile    Boolean             @default(false)
  isBank          Boolean             @default(false)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  payrollSessions AttendanceSession[] @relation("PayrollHoliday")
  workSessions    AttendanceSession[] @relation("WorkHoliday")
  calendar        Calendar            @relation(fields: [calendarId], references: [id], onDelete: Cascade)
  leaveRequests   LeaveRequest[]

  @@unique([calendarId, date])
  @@index([date])
  @@map("holidays")
}

model Salary {
  id               String       @id @default(uuid())
  employeeId       String
  companyId        String
  periodStartDate  DateTime
  periodEndDate    DateTime
  payDate          DateTime
  basicSalary      Float        @default(0.0)
  otAmount         Float        @default(0.0)
  otBreakdown      Json?        @default("[]")
  noPayAmount      Float        @default(0.0)
  noPayBreakdown   Json?        @default("[]")
  taxAmount        Float        @default(0.0)
  components       Json?        @default("[]")
  advanceDeduction Float        @default(0.0)
  netSalary        Float        @default(0.0)
  status           SalaryStatus @default(DRAFT)
  remarks          String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  payments         Payment[]
  company          Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee         Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, periodStartDate, periodEndDate])
  @@index([companyId, periodStartDate, periodEndDate])
  @@index([status])
  @@map("salaries")
}

model SalaryAdvance {
  id                String        @id @default(uuid())
  employeeId        String
  companyId         String
  totalAmount       Float
  date              DateTime      @default(now())
  reason            String?
  deductionSchedule Json?         @default("[]")
  remainingAmount   Float
  status            AdvanceStatus @default(PENDING)
  remarks           String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  payments          Payment[]
  company           Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee          Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([companyId])
  @@index([status])
  @@map("salary_advances")
}

model Payment {
  id            String         @id @default(uuid())
  companyId     String
  salaryId      String?
  advanceId     String?
  amount        Float
  date          DateTime       @default(now())
  paymentMethod PaymentMethod  @default(CASH)
  referenceNo   String?
  remarks       String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  advance       SalaryAdvance? @relation(fields: [advanceId], references: [id])
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  salary        Salary?        @relation(fields: [salaryId], references: [id])

  @@index([companyId])
  @@index([salaryId])
  @@index([advanceId])
  @@map("payments")
}

enum Role {
  ADMIN
  EMPLOYER
  EMPLOYEE
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum EmploymentType {
  PROBATION
  PERMANENT
  CONTRACT
  INTERN
  TEMPORARY
}

enum Gender {
  MALE
  FEMALE
}

enum MaritalStatus {
  SINGLE
  MARRIED
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum LeaveRequestType {
  FULL_DAY
  HALF_DAY_FIRST
  HALF_DAY_LAST
  SHORT_LEAVE
}

enum EventType {
  IN
  OUT
}

enum EventSource {
  WEB
  API_KEY
  MANUAL
}

enum EventStatus {
  ACTIVE
  REJECTED
  IGNORED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SessionWorkDayStatus {
  FULL
  HALF_FIRST
  HALF_LAST
  OFF
}

enum SalaryStatus {
  DRAFT
  APPROVED
  PARTIALLY_PAID
  PAID
}

enum AdvanceStatus {
  PENDING
  APPROVED
  PAID
  RECOVERED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHEQUE
  OTHER
}
